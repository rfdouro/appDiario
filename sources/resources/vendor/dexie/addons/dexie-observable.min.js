(function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("dexie")):"function"==typeof define&&define.amd?define(["dexie"],n):(e.Dexie=e.Dexie||{},e.Dexie.Observable=n(e.Dexie))})(this,function(N){"use strict";function T(){}function S(o,r){return o===T?r:function(){var e=o.apply(this,arguments);if(e&&"function"==typeof e.then){var n=this,t=arguments;return e.then(function(){return r.apply(n,t)})}return r.apply(this,arguments)}}function c(){var t=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?n:7&n|8).toString(16)})}N=N&&N.hasOwnProperty("default")?N.default:N;var u=1,v=2,a=3;function D(t){return function(e){if(!e.hook._observing){e.hook._observing=!0;var n=e.name;e.hook("creating").subscribe(function(a,s){return function(n,e,t){var o=void 0;void 0===n&&s.schema.primKey.uuid&&(n=o=c(),s.schema.primKey.keyPath&&N.setByKeyPath(e,s.schema.primKey.keyPath,n));var r={source:t.source||null,table:s.name,key:void 0===n?null:n,type:u,obj:e},i=a._changes.add(r).then(function(e){return t._lastWrittenRevision=Math.max(t._lastWrittenRevision,e),e});return this.onsuccess=function(e){n!=e&&i._then(function(){r.key=e,a._changes.put(r)})},this.onerror=function(){i._then(function(e){a._changes.delete(e)})},o}}(t,e)),e.hook("updating").subscribe(function(f,m){return function(e,n,t,o){var r={},i=!1,a=N.deepClone(t);for(var s in e){var c=e[s];if(void 0===c)N.delByKeyPath(a,s),i=!(r[s]=null);else{var u=N.getByKeyPath(t,s);c!==u&&JSON.stringify(c)!==JSON.stringify(u)&&(N.setByKeyPath(a,s,c),r[s]=c,i=!0)}}if(i){var l={source:o.source||null,table:m,key:n,type:v,mods:r,oldObj:t,obj:a},d=f._changes.add(l);this.onsuccess=function(){d._then(function(e){o._lastWrittenRevision=Math.max(o._lastWrittenRevision,e)})},this.onerror=function(){d._then(function(e){f._changes.delete(e)})}}}}(t,n)),e.hook("deleting").subscribe(function(r,i){return function(e,n,t){var o=r._changes.add({source:t.source||null,table:i,key:e,type:a,oldObj:n}).then(function(e){return t._lastWrittenRevision=Math.max(t._lastWrittenRevision,e),e}).catch(function(e){console.log(n),console.log(e.stack)});this.onerror=function(){o._then(function(e){r._changes.delete(e)})}}}(t,n))}}}var l=N.Promise;function M(i,a,e,s,c){var u={};function n(){return s.node?N.ignoreTransaction(function(){return i.transaction("rw","_intercomm",function(){return i._intercomm.where({destinationNode:s.node.id}).toArray(function(e){return e.forEach(function(e){return function(n){if("response"===n.type){var e=u[n.requestId.toString()];e&&(n.isFailure?e.reject(n.message.error):e.resolve(n.message.result),delete u[n.requestId.toString()])}else n.resolve=function(e){i.observable.sendMessage("response",{result:e},n.sender,{requestId:n.id})},n.reject=function(e){i.observable.sendMessage("response",{error:e.toString()},n.sender,{isFailure:!0,requestId:n.id})},i.on.message.fire(n)}(e)}),i._intercomm.where("id").anyOf(e.map(function(e){return e.id})).delete()})})}):l.reject(new N.DatabaseClosedError)}return i.observable.sendMessage=function(e,n,t,o){if(o=o||{},!s.node)return o.wantReply?l.reject(new N.DatabaseClosedError):l.resolve();var r={message:n,destinationNode:t,sender:s.node.id,type:e};return N.extend(r,o),N.ignoreTransaction(function(){var e=["_intercomm"];o.wantReply&&e.push("_syncNodes");var n=i.transaction("rw",e,function(){return o.wantReply?i._syncNodes.where("id").equals(t).count(function(e){return e?i._intercomm.add(r):i._syncNodes.where("isMaster").above(0).first(function(e){return r.destinationNode=e.id,i._intercomm.add(r)})}):i._intercomm.add(r)}).then(function(t){var e=null;return o.wantReply&&(e=new l(function(e,n){u[t.toString()]={resolve:e,reject:n}})),c&&c.setItem("Dexie.Observable/intercomm/"+i.name,t.toString()),a.on.intercomm.fire(i.name),e});return o.wantReply?n:void n.catch(function(){})})},i.observable.broadcastMessage=function(n,t,o){if(s.node){var r=s.node.id;N.ignoreTransaction(function(){i._syncNodes.toArray(function(e){return l.all(e.filter(function(e){return"local"===e.type&&(o||e.id!==r)}).map(function(e){return i.observable.sendMessage(n,t,e.id)}))}).catch(function(){})})}},{onIntercomm:function(e){e===i.name&&n().catch("DatabaseClosedError",function(){})},consumeIntercommMessages:n}}function B(n){return function(e,t){e._changes="++rev",e._syncNodes="++id,myRevision,lastHeartBeat,&url,isMaster,type,status",e._intercomm="++id,destinationNode",e._uncommittedChanges="++id,node",n.call(this,e,t),Object.keys(t).forEach(function(e){var n=t[e];0===n.primKey.name.indexOf("$$")&&(n.primKey.uuid=!0,n.primKey.name=n.primKey.name.substr(2),n.primKey.keyPath=n.primKey.keyPath.substr(2))}),Object.keys(t).forEach(function(e){0!==e.indexOf("_")&&0!==e.indexOf("$")&&(t[e].observable=!0)})}}var s,C=self,I=N.defineClass({rev:Number,source:String,table:String,key:Object,type:Number,obj:Object,mods:Object,oldObj:Object}),j=N.override,k=N.Promise,E=!1;function H(a){if(!/^3\./.test(N.version))throw new Error("Missing dexie version 3.x");if(a.observable){if("3.0.0-beta.10"!==a.observable.version)throw new Error("Mixed versions of dexie-observable")}else{var o=2e4,r=2e4,t=500,i=o-5e3,s=H.localStorageImpl,c=N.defineClass({myRevision:Number,type:String,lastHeartBeat:Number,deleteTimeStamp:Number,url:String,isMaster:Number,syncProtocol:String,syncContext:null,syncOptions:Object,connected:!1,status:Number,appliedRemoteRevision:null,remoteBaseRevisions:[{local:Number,remote:null}],dbUploadState:{tablesToUpload:[String],currentTable:String,currentKey:null,localBaseRevision:Number}});a.observable={version:"3.0.0-beta.10"},a.observable.SyncNode=c;var n=function(n,t,o){return function(e){t.latestRevision[n.name]<e&&(t.latestRevision[n.name]=e,N.ignoreTransaction(function(){t.on("latestRevisionIncremented").fire(n.name,e)}),o&&o.setItem("Dexie.Observable/latestRevision/"+n.name,e))}}(a,H,s),e=function(s,c){return function(a){return function(e,n,t,o){if(s.dynamicallyOpened())return a.apply(this,arguments);var r=!1;"readwrite"===e&&n.some(function(e){return t[e]&&t[e].observable})&&(r=!0,-1===(n=n.slice(0)).indexOf("_changes")&&n.push("_changes"));var i=a.call(this,e,n,t,o);return r&&(i._lastWrittenRevision=0,i.on("complete",function(){if(i._lastWrittenRevision)if(o){var e=function e(n){return n.parent?e(n.parent):n}(o);e._lastWrittenRevision=Math.max(i._lastWrittenRevision,e.lastWrittenRevision||0)}else c.timeoutHandle&&clearTimeout(c.timeoutHandle),c.timeoutHandle=setTimeout(function(){delete c.timeoutHandle,c(i._lastWrittenRevision)},25)}),i.parent&&i.parent.source&&(i.source=i.parent.source)),i}}}(a,n),u=D(a),l=function(t,o,r){return function(e){return function(){return Object.keys(t._allTables).forEach(function(e){var n=t._allTables[e];n.schema.observable&&r(n),"_syncNodes"===n.name&&n.mapToClass(o)}),e.apply(this,arguments)}}}(a,c,u),d={node:null},f=M(a,H,0,d,s),m=f.onIntercomm,v=f.consumeIntercommMessages;Object.defineProperty(a,"_localSyncNode",{get:function(){return d.node}});var y=null,p=null;N.fake&&(a.version(1).stores({_syncNodes:"++id,myRevision,lastHeartBeat",_changes:"++rev",_intercomm:"++id,destinationNode",_uncommittedChanges:"++id,node"}),a._syncNodes.mapToClass(c),a._changes.mapToClass(I),d.node=new c({myRevision:0,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null})),a.Version.prototype._parseStoresSpec=j(a.Version.prototype._parseStoresSpec,B),a.on.addEventType({changes:"asap",cleanup:[S,T],message:"asap"}),a._createTransaction=j(a._createTransaction,e),H.latestRevision[a.name]=H.latestRevision[a.name]||0,a.open=j(a.open,l),a.close=j(a.close,function(e){return function(){return a.dynamicallyOpened()||(n.timeoutHandle&&(clearTimeout(n.timeoutHandle),delete n.timeoutHandle),H.on("latestRevisionIncremented").unsubscribe(h),H.on("suicideNurseCall").unsubscribe(O),H.on("intercomm").unsubscribe(m),H.on("beforeunload").unsubscribe(R),d.node&&d.node.id&&(H.on.suicideNurseCall.fire(a.name,d.node.id),s&&s.setItem("Dexie.Observable/deadnode:"+d.node.id.toString()+"/"+a.name,"dead"),d.node.deleteTimeStamp=1,d.node.lastHeartBeat=0,a._syncNodes.put(d.node),d.node=null),y&&clearTimeout(y),y=null,p&&clearTimeout(p),p=null),e.apply(this,arguments)}}),a.delete=j(a.delete,function(e){return function(){return e.apply(this,arguments).then(function(e){return H.latestRevision[a.name]=0,e})}}),a.on("ready",function(){return a.dynamicallyOpened()?a:a.table("_changes").orderBy("rev").last(function(e){var n=e?e.rev:0;return d.node=new c({myRevision:n,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null,isMaster:0}),H.latestRevision[a.name]<n&&(H.latestRevision[a.name]=n,N.ignoreTransaction(function(){H.on.latestRevisionIncremented.fire(n)})),a._syncNodes.put(d.node).then(N.ignoreTransaction(function(){var n=1;return a._syncNodes.orderBy("isMaster").reverse().modify(function(e){e.isMaster&&(e.lastHeartBeat<Date.now()-o?e.isMaster=0:n=0),d.node&&e.id===d.node.id&&(e.isMaster=d.node.isMaster=n)})})).then(function(){H.on("latestRevisionIncremented",h),H.on("beforeunload",R),H.on("suicideNurseCall",O),H.on("intercomm",m),y=setTimeout(x,t),p=setTimeout(_,i)}).then(function(){w()})})},!0);var b=0}function h(e,n){if(e===a.name){if(n<=b)return;b=n,N.vip(function(){g(n).catch("DatabaseClosedError",function(){})})}}function g(e,n,o){if(!n&&g.ongoingOperation)return g.ongoingOperation;var r=!1,i=d.node;if(!i)return k.reject(new N.DatabaseClosedError);var t=a._changes.where("rev").above(i.myRevision).limit(1e3).toArray(function(e){if(0<e.length){var n=e[e.length-1];r=1e3===e.length,a.on("changes").fire(e,r),i.myRevision=n.rev}else o&&a.on("changes").fire([],!1);var t=!1;return a._syncNodes.where(":id").equals(i.id).modify(function(e){t=!0,e.lastHeartBeat=Date.now(),e.deleteTimeStamp=null,e.myRevision=Math.max(e.myRevision,i.myRevision)}).then(function(){return t})}).then(function(e){if(!e)throw E?new Error("Browser is shutting down"):(a.close(),console.error("Out of sync"),C.location&&C.location.reload(!0),new Error("Out of sync"));if(r||H.latestRevision[a.name]>i.myRevision)return g(H.latestRevision[a.name],(n||0)+1,r)}).finally(function(){delete g.ongoingOperation});return n||(g.ongoingOperation=t),t}function _(){p=null;var e=d.node&&d.node.id;e&&a.transaction("rw!",a._syncNodes,function(){a._syncNodes.where({id:e}).first(function(e){if(e)return e.lastHeartBeat=Date.now(),e.deleteTimeStamp=null,a._syncNodes.put(e);a.isOpen()&&a.close()})}).catch("DatabaseClosedError",function(){}).finally(function(){d.node&&d.node.id===e&&a.isOpen()&&(p=setTimeout(_,i))})}function x(){y=null;var e=d.node&&d.node.id;e&&N.vip(function(){g(H.latestRevision[a.name]).then(w).then(v).catch("DatabaseClosedError",function(){}).finally(function(){d.node&&d.node.id===e&&a.isOpen()&&(y=setTimeout(x,t))})})}function w(){var t=d.node;return t?a.transaction("rw","_syncNodes","_changes","_intercomm",function(){var n=!1;a._syncNodes.where("lastHeartBeat").below(Date.now()-o).filter(function(e){return"local"===e.type}).modify(function(e){e.deleteTimeStamp&&e.deleteTimeStamp<Date.now()?(delete this.value,s&&s.removeItem("Dexie.Observable/deadnode:"+e.id+"/"+a.name),e.isMaster&&(a._syncNodes.update(t,{isMaster:1}),n=!0),a._intercomm.where({destinationNode:e.id}).modify(function(e){e.wantReply?e.destinationNode=t.id:delete this.value})):e.deleteTimeStamp||(e.deleteTimeStamp=Date.now()+r)}).then(function(){return H.deleteOldChanges(a),a.on("cleanup").fire(n)})}):k.reject(new N.DatabaseClosedError)}function R(){d.node&&(E=!0,d.node.deleteTimeStamp=1,d.node.lastHeartBeat=0,a._syncNodes.put(d.node),H.wereTheOneDying=!0,s&&s.setItem("Dexie.Observable/deadnode:"+d.node.id.toString()+"/"+a.name,"dead"))}function O(e,n){e!==a.name||H.wereTheOneDying||N.vip(function(){a._syncNodes.update(n,{deleteTimeStamp:1,lastHeartBeat:0}).then(w)})}}H.version="3.0.0-beta.10",H.latestRevision={},H.on=N.Events(null,"latestRevisionIncremented","suicideNurseCall","intercomm","beforeunload"),H.createUUID=c,H.deleteOldChanges=function n(t){N.ignoreTransaction(function(){return t._syncNodes.orderBy("myRevision").first(function(e){return t._changes.where("rev").below(e.myRevision).limit(100).primaryKeys()}).then(function(e){if(0!==e.length)return t._changes.bulkDelete(e).then(function(){100===e.length&&setTimeout(function(){return t.isOpen()&&n(t)},500)})})}).catch(function(){})},H._onStorage=(s=H,function(e){if(e.key&&0===e.key.indexOf("Dexie.Observable/")){var n=e.key.split("/"),t=n[1],o=n[2];if("latestRevision"===t){var r=parseInt(e.newValue,10);!isNaN(r)&&r>s.latestRevision[o]&&(s.latestRevision[o]=r,N.ignoreTransaction(function(){s.on("latestRevisionIncremented").fire(o,r)}))}else if(0===t.indexOf("deadnode:")){var i=parseInt(t.split(":")[1],10);e.newValue&&s.on.suicideNurseCall.fire(o,i)}else"intercomm"===t&&e.newValue&&s.on.intercomm.fire(o)}}),H._onBeforeUnload=function(){H.on.beforeunload.fire()};try{H.localStorageImpl=C.localStorage}catch(e){}if(C.addEventListener&&(C.addEventListener("storage",H._onStorage),C.addEventListener("beforeunload",H._onBeforeUnload)),N.Observable){if("3.0.0-beta.10"!==N.Observable.version)throw new Error("Mixed versions of dexie-observable")}else N.Observable=H,N.addons.push(H);return N.Observable});